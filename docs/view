#!/usr/bin/env python

import os
import sys
import webbrowser

from os.path import abspath, isfile

styles = """
<link rel="stylesheet" href="http://www.python.org/css/pypi.css" type="text/css"/>
<link media="screen" href="http://www.python.org/styles/screen-switcher-default.css" type="text/css" id="screen-switcher-stylesheet" rel="stylesheet"/>
<link media="screen" href="http://www.python.org/styles/netscape4.css" type="text/css" rel="stylesheet"/>
<link media="print" href="http://www.python.org/styles/print.css" type="text/css" rel="stylesheet"/>
<link media="screen" href="http://www.python.org/styles/largestyles.css" type="text/css" rel="alternate stylesheet" title="large text"/>
<link media="screen" href="http://www.python.org/styles/defaultfonts.css" type="text/css" rel="alternate stylesheet" title="default fonts"/>
<style type="text/css">
body {margin-left: 6em; margin-right: 6em; font-size: 95%;}
a {text-decoration: none;}
</style>
"""

def readlines(filename, mode='rt'):
    file = open(filename, mode)
    try:
        return file.readlines()
    finally:
        file.close()

def apply_styles(outfile):
    outlines = readlines(outfile)
    f = open(outfile, 'wt')
    for line in outlines:
        if line.strip() == '</head>':
            f.write(styles)
        f.write(line)
    f.close()

def main(args):
    if len(args) > 1:
        print >>sys.stderr, 'Too many arguments'
        return 1
    if args:
        infile = abspath(args[0])
        outfile = abspath('.'+args[0]+'.html')
        rc = os.system('rst2html %s %s' % (infile, outfile))
    else:
        if not isfile('setup.py'):
            print >>sys.stderr, 'No setup.py found'
            return 1
        outfile = abspath('.long-description.html')
        rc = os.system('%s setup.py --long-description | rst2html > %s' % (sys.executable, outfile))
    if rc == 0:
        apply_styles(outfile)
        webbrowser.open('file://'+outfile)
    return rc

if __name__ == '__main__':
    sys.exit(main(sys.argv[1:]))

